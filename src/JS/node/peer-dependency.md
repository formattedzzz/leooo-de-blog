# åˆè¯† npm ä¾èµ–æ¨¡å‹

## ä¸€äº› npm æ“ä½œ

```sh
# æŸ¥çœ‹æŸä¸ªåŒ…
npm view @leooo/leoui

# æŸ¥çœ‹æŸä¸ªå½“å‰ç‰ˆæœ¬
npm view @leooo/leoui version

# æŸ¥çœ‹æŸä¸ªåŒ…
npm view @leooo/leoui versions

# æŸ¥çœ‹é¡¹ç›®åŒ…ä¾èµ–æ¨¡å‹ï¼ˆæ…ï¼‰
npm ls
```

## ç‰ˆæœ¬å·

```js
{
  "dependencies": {
    "signale": "1.4.0",
    // å›ºå®šç‰ˆæœ¬å·
    "figlet": "*",
    // ä»»æ„ç‰ˆæœ¬ï¼ˆ>=0.0.0ï¼‰
    "react": "16.x",
    // åŒ¹é…ä¸»è¦ç‰ˆæœ¬ï¼ˆ>=16.0.0 <17.0.0ï¼‰
    "table": "~5.4.6",
    // å®‰è£…åˆ° x.y.z ä¸­ z çš„æœ€æ–°çš„ç‰ˆæœ¬
    "yargs": "^14.0.0"
    // å®‰è£…åˆ° x.y.z ä¸­ y å’Œ z éƒ½ä¸ºæœ€æ–°ç‰ˆæœ¬
  }
}
```

## å„ç§ä¾èµ–

- dependencies

  ç”Ÿäº§ä¾èµ–ã€‚ æ¯”å¦‚ `antd` ä¾èµ–äº† `moment` å®‰è£…äº† `antd` ä¹Ÿä¼šå®‰è£… `moment` å¹¶ä¸”å¯ä»¥ç›´æ¥åœ¨ä¸šåŠ¡ä¸­å¼•ç”¨(>=npm3.x)

- devDependencies

  å¼€å‘ç¯å¢ƒä¾èµ–ã€‚

- peerDependencies

  å¯¹ç­‰ä¾èµ–ã€‚ æ¯”å¦‚ `react` `react-dom` æ˜¯ `antd` çš„å¯¹ç­‰ä¾èµ–ã€‚

  å¦‚æœå®‰è£…äº† `antd` `npm` ä¼šæ£€æŸ¥ä½ åœ¨é¡¹ç›®ä¸­æœ‰æ²¡æœ‰å®‰è£… åˆæ ¼ç‰ˆæœ¬çš„å¯¹ç­‰ä¾èµ–

  å¦‚æœæ²¡æœ‰å°±ä¼šæŠ¥è­¦å‘Š (åœ¨ `npm2` æ—¶ä»£ä¼šååŒå®‰è£…)

## node_modules ä¾èµ–æ¨¡å‹

### åµŒå¥—æ¨¡å‹

å‡è®¾é¡¹ç›®ä¾èµ–å¦‚ä¸‹ï¼š

```json
{
  "name": "my-project",
  "dependencies": {
    "buffer": "^5.4.3",
    "ignore": "^5.1.4"
  }
}
```

`ignore` åŒ…æ˜¯çº¯ js åº“ æ— å¤–éƒ¨ä¾èµ–

è€Œ`buffer` åŒ…çš„ä¾èµ–

```json
{
  "name": "buffer",
  "dependencies": {
    "base64-js": "^1.0.2",
    "ieee754": "^1.1.4"
  }
}
```

åœ¨`npm2.x`æ—¶ npm ä¼šä¸€ç›´åµŒå¥—å®‰è£…ä¸‹å» è£…å®Œä¹‹å `node_modules` ä¸‹å°±ä¸¤ä¸ªæ–‡ä»¶å¤¹

```txt
node_modules
--buffer
--ignore
```

å¦‚æœä¾èµ–ä¸€å¤š `node_modules` å°†å±‚å±‚åµŒå¥—ä¸”å˜å¾—éå¸¸å¤§ å¦‚æœ pkgA è·Ÿ pkgB ç›¸äº’ä¾èµ–é‚£å²‚ä¸æ˜¯è¦ä¸€ç›´è£…ä¸‹å»ï¼Ÿ

### æ‰å¹³æ¨¡å‹

åˆ°äº† `npm3.x` å…¶å°†æ—©æœŸçš„åµŒå¥—ç»“æ„æ”¹ä¸ºæ‰å¹³ç»“æ„ å®‰è£…æ¨¡å—æ—¶ ä¸ç®¡å…¶æ˜¯ç›´æ¥ä¾èµ–è¿˜æ˜¯å­ä¾èµ–çš„ä¾èµ– ä¼˜å…ˆå°†å…¶å®‰è£…åœ¨ `node_modules` æ ¹ç›®å½• ä½†æ˜¯æ¯ä¸ªåŒ…ä¾ç„¶ä¼šå®‰è£…å®Œæ•´çš„ `node_modules`

è¿™æ—¶å€™å¦‚æœé¡¹ç›®ä¸­åˆåŠ ä¸€ä¸ªä¾èµ– `base64-js` é‚£ä¹ˆ npm å†åœ¨ `node_modules` ä¸­æ£€æŸ¥å·²å®‰è£… `base64-js` ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚ ç¬¦åˆå°±è·³è¿‡

è¿™å°±é€ æˆäº† ä¸åŒç‰ˆæœ¬çš„ä¾èµ–å…ˆåé¡ºåºä¼šé€ æˆä¸åŒçš„`node_modules`ç»“æ„

å¼€å‘ç³»ç»Ÿåº”ç”¨æ—¶ å»ºè®®æŠŠ `package-lock.json` æ–‡ä»¶æäº¤åˆ°ä»£ç ç‰ˆæœ¬ä»“åº“ ä»è€Œä¿è¯æ‰€æœ‰å›¢é˜Ÿå¼€å‘è€…ä»¥åŠ CI ç¯èŠ‚å¯ä»¥åœ¨æ‰§è¡Œ npm install æ—¶å®‰è£…çš„ä¾èµ–ç‰ˆæœ¬éƒ½æ˜¯ä¸€è‡´çš„ã€‚
åœ¨å¼€å‘ä¸€ä¸ª npm åŒ… æ—¶ ä½ çš„ npm åŒ… æ˜¯éœ€è¦è¢«å…¶ä»–ä»“åº“ä¾èµ–çš„ ç”±äºä¸Šé¢æˆ‘ä»¬è®²åˆ°çš„æ‰å¹³å®‰è£…æœºåˆ¶ å¦‚æœä½ é”å®šäº†ä¾èµ–åŒ…ç‰ˆæœ¬ ä½ çš„ä¾èµ–åŒ…å°±ä¸èƒ½å’Œå…¶ä»–ä¾èµ–åŒ…å…±äº«åŒä¸€ `semver` èŒƒå›´å†…çš„ä¾èµ–åŒ… è¿™æ ·ä¼šé€ æˆä¸å¿…è¦çš„å†—ä½™ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸åº”è¯¥æŠŠ `package-lock.json` æ–‡ä»¶å‘å¸ƒå‡ºå»ï¼ˆ npm é»˜è®¤ä¹Ÿä¸ä¼šæŠŠ `package-lock.json` æ–‡ä»¶å‘å¸ƒå‡ºå»ï¼‰

## npm ç¼“å­˜

`npm5.x` ä¹‹åæœ‰äº†ç¼“å­˜ç­–ç•¥
æŸ¥çœ‹ç¼“å­˜å­˜å–ç›®å½•

```sh
npm config get cache
# /Users/liufulin/.npm
```

![npm-cache](https://i.loli.net/2020/03/13/lfBXDV41eMFuh5N.png)

æ¸…é™¤ç¼“å­˜

```sh
npm cache clean
```

## åˆå§‹åŒ–å®‰è£…çš„ `node_modules` çš„å¤§è‡´æœºåˆ¶

- ä» npm è¿œç¨‹ä»“åº“è·å–åŒ…ä¿¡æ¯
- æ ¹æ® `package.json` æ„å»ºä¾èµ–æ ‘ æ„å»ºè¿‡ç¨‹ï¼š

  æ„å»ºä¾èµ–æ ‘æ—¶ ä¸ç®¡å…¶æ˜¯ç›´æ¥ä¾èµ–è¿˜æ˜¯å­ä¾èµ–çš„ä¾èµ– ä¼˜å…ˆå°†å…¶æ”¾ç½®åœ¨ `node_modules` æ ¹ç›®å½•ã€‚

  å½“é‡åˆ°ç›¸åŒæ¨¡å—æ—¶ åˆ¤æ–­å·²æ”¾ç½®åœ¨ä¾èµ–æ ‘çš„æ¨¡å—ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆæ–°æ¨¡å—çš„ç‰ˆæœ¬èŒƒå›´ å¦‚æœç¬¦åˆåˆ™è·³è¿‡ ä¸ç¬¦åˆåˆ™åœ¨å½“å‰æ¨¡å—çš„ `node_modules` ä¸‹æ”¾ç½®è¯¥æ¨¡å—ã€‚

  æ³¨æ„è¿™ä¸€æ­¥åªæ˜¯ç¡®å®šé€»è¾‘ä¸Šçš„ä¾èµ–æ ‘ å¹¶éçœŸæ­£çš„å®‰è£… åé¢ä¼šæ ¹æ®è¿™ä¸ªä¾èµ–ç»“æ„å»ä¸‹è½½æˆ–æ‹¿åˆ°ç¼“å­˜ä¸­çš„ä¾èµ–åŒ…

- åœ¨ç¼“å­˜ä¸­ä¾æ¬¡æŸ¥æ‰¾ä¾èµ–æ ‘ä¸­çš„æ¯ä¸ªåŒ…

  - ä¸å­˜åœ¨ç¼“å­˜ï¼šä» npm è¿œç¨‹ä»“åº“ä¸‹è½½åŒ… æ ¡éªŒåŒ…çš„å®Œæ•´æ€§

    æ ¡éªŒä¸é€šè¿‡ï¼š é‡æ–°ä¸‹è½½

    æ ¡éªŒé€šè¿‡ï¼š å°†ä¸‹è½½çš„åŒ…å¤åˆ¶åˆ° npm ç¼“å­˜ç›®å½• å°†ä¸‹è½½çš„åŒ…æŒ‰ç…§ä¾èµ–ç»“æ„è§£å‹åˆ° `node_modules`

  - å­˜åœ¨ç¼“å­˜ï¼šå°†ç¼“å­˜æŒ‰ç…§ä¾èµ–ç»“æ„è§£å‹åˆ° `node_modules`

- å°†åŒ…è§£å‹åˆ° `node_modules`
- ç”Ÿæˆ `lock` æ–‡ä»¶

## æ¥çœ‹çœ‹ yran node_modules æ¨¡å‹

å®‰è£… `babel-plugin-import` åŒ… è¯¥åŒ…çš„ç”Ÿäº§ä¾èµ–æœ‰ä¸¤ä¸ª

```json
{
  "dependencies": {
    "@babel/helper-module-imports": "^7.0.0",
    "@babel/runtime": "^7.0.0"
  }
}
```

<!-- `node_modules` ç»“æ„å›¾å¯¹æ¯”

![npm.png](https://i.loli.net/2020/03/19/w4DABgvpaMb6XrT.png)

å¯ä»¥çœ‹åˆ° `babel-plugin-import` ç›®å½•ä¸‹å®Œæ•´è£…äº†å…¶ç”Ÿäº§ä¾èµ– `node_modules` åˆé€’å½’æŠŠå…¶æ¯ä¸ªç”Ÿäº§ä¾èµ–çš„éœ€è¦çš„ç”Ÿäº§ä¾èµ–æ‰å¹³å®‰è£…åˆ°äº†
`node_modules` æ ¹ç›®å½•ä¸‹é¢ -->

![yarn.png](https://i.loli.net/2020/03/19/56rfL7nsZzkeG89.png)

`babel-plugin-import` ç›®å½•ä¸‹æ—  `node_modules` å…¨éƒ¨ç”Ÿäº§ä¾èµ–æ‰å¹³è£…åˆ°äº†é¡¹ç›® `node_modules` çš„æ ¹ç›®å½•ä¸‹

æ¥ä¸‹æ¥æˆ‘ä»¬å†å®‰è£… `@babel/runtime@7.0.0` å¾ˆæ˜¾ç„¶ `node_modules` å·²ç»æœ‰ 7.0.0 çš„ç‰ˆæœ¬äº† ä¸ä¼šå†å®‰è£…

å¦‚æœå»æ‰ç‰ˆæœ¬å·åˆ™ä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬ æ›´æ–°åˆ° `@babel/runtime@7.8.7`

```sh
yarn add @babel/runtime
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
warning Pattern ["@babel/runtime@^7.8.7"] is trying to unpack in the same destination "/Users/liufulin/Library/Caches/Yarn/v6/npm-@babel-runtime-7.8.7-8fefce9802db54881ba59f90bb28719b4996324d-integrity/node_modules/@babel/runtime" as pattern ["@babel/runtime@^7.0.0"]. This could result in non-deterministic behavior, skipping.
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...
success Saved lockfile.
success Saved 1 new dependency.
info Direct dependencies
â””â”€ @babel/runtime@7.8.7
info All dependencies
â””â”€ @babel/runtime@7.8.7
âœ¨  Done in 2.74s.
```

`node_modules/babel-plugin-import/lib/` ç›®å½•ä¸‹å¯ä»¥ `require("@babel/helper-module-imports")` å—ï¼Ÿ
å½“ç„¶å¯ä»¥
